{{/*
  Return BuyLink URL corresponding to Service and ISBN

  @author @regisphilibert

  @context Map
            String (.service)
            String (.ISBN)

  @access public

  @example - Go Template
    {{ $url := partial "tnd-books/private/GetBuyLinkURL" (dict "service" "amazon" "isbn" $isbn) }}
*/}}
{{ $retailer := .retailer }}
{{ $edition := .edition }}
{{ $url := false }}
{{ $isbn := false }}
{{ $asin := false }}
{{ with $edition.isbn }}
  {{ $isbn = . }}
  {{ if in . "-" }}
    {{ $isbn = replace $isbn "-" "" }}
  {{ end }}
  {{ if not (partialCached "tnd-books/private/IsISBNValid" $isbn $isbn) }}
    {{ partial "tnd-books/warn" (printf "ISBN `%s` is not a valid ISBN" $isbn) }}
    {{ $isbn = false }}
  {{ end }}
{{ end }}

{{ with $edition.asin }}
  {{ $asin = . }}
{{ else }}
  {{ with $isbn }}
    {{ with partial "tnd-books/private/ISBNToASIN" $isbn }}
      {{ $asin = . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Only default books require the ISBN. */}}
{{ with $isbn }}
  {{ if eq $.retailer "barnesandnoble" }}
    {{ $url = printf "https://www.barnesandnoble.com/w/?ean=%v#/" . }}
  {{ else if eq $.retailer "bookshop" }}
    {{ $url = printf "https://www.bookshop.org/a/287/%s" . }}
  {{ else if eq $.retailer "libro" }}
    {{ $url = printf "https://libro.fm/audiobooks/%s" . }}
  {{ end }}
{{ end }}

{{/* If ASIN is found or built, we can build the following: */}}
{{ with $asin }}
  {{ if eq $retailer "amazon" "amazon_kindle" "kindle" "audible" "amazon_audible" }}
    {{ $url = printf "https://www.amazon.com/dp/%s" $asin }}
  {{ end }}
{{ end }}

{{/* Some retailers only need a dedicated parameter in the edition foramted as {retailer}_url */}}
{{ range slice "audible" "amazon_audible" "apple_books" }}
  {{ if eq $retailer . }}
    {{ with index $edition (printf "%s_url" .) }}
      {{ $url = . }}
    {{ end }}
  {{ end }}
{{ end }}

{{ return $url }}